<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essay Center — Order Manager</title>

  <!-- Font Awesome for icons (optional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg: #ffffff;
      --accent: #58a6ff;   /* light blue */
      --accent-2: #cfe9ff;
      --muted: #6b7280;
      --card: #f8fbff;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, #f6fbff 0%, #ffffff 100%);
      color:#111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      height:100vh;
      gap:20px;
      padding:20px;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg,var(--card),#fff);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 6px 18px rgba(14,30,37,0.06);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: calc(100vh - 40px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo {
      width:44px;height:44px;border-radius:10px;background:var(--accent);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;
      box-shadow:0 4px 10px rgba(88,166,255,0.25);
    }
    .brand h2{margin:0;font-size:1.05rem}
    .brand p{margin:0;font-size:0.85rem;color:var(--muted)}

    .nav {
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-top:8px;
    }
    .nav button{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:10px;
      background:transparent;
      border: none;
      cursor:pointer;
      font-size:0.95rem;
      color: #0f172a;
      text-align:left;
    }
    .nav button .count{
      margin-left:auto;
      background:var(--accent-2);
      color:var(--accent);
      padding:4px 8px;border-radius:999px;font-weight:600;font-size:0.8rem;
    }
    .nav button.active{
      background: linear-gradient(90deg,var(--accent-2),rgba(207,233,255,0.4));
      box-shadow: inset 0 0 0 1px rgba(88,166,255,0.08);
      color: #03396c;
    }

    .create-btn{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border-radius:10px;
      background:var(--accent);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 6px 16px rgba(88,166,255,0.18);
    }

    /* Main content */
    .main {
      display:flex;flex-direction:column;
      gap:16px;
      min-height: calc(100vh - 40px);
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      background:transparent;padding:6px 12px;
    }
    .wallet{
      display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),#eef9ff);
      box-shadow:0 4px 10px rgba(88,166,255,0.06);
    }
    .wallet .label{font-size:0.85rem;color:var(--muted)}
    .wallet .amount{font-weight:700;font-size:1rem;color:#032b47}

    .profile{
      display:flex;align-items:center;gap:10px;position:relative;
    }
    .profile .avatar{
      width:42px;height:42px;border-radius:999px;background:linear-gradient(90deg,#9ad7ff,#5aaeff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }
    .profile .name{font-size:0.9rem}

    .profile-menu{
      position:absolute;right:0;top:56px;background:white;border-radius:10px;padding:12px;width:260px;box-shadow:0 10px 30px rgba(2,6,23,0.12);display:none;
    }
    .profile-menu.show{display:block}
    .profile-menu .meta{display:flex;gap:12px;align-items:center}
    .profile-menu .meta .avatar{width:56px;height:56px}
    .profile-menu .meta .info .nm{font-weight:700}
    .profile-menu .meta .info .sub{font-size:0.85rem;color:var(--muted)}

    /* Body content area */
    .content{
      background:white;padding:18px;border-radius:12px;box-shadow:0 8px 26px rgba(14,30,37,0.05);flex:1;overflow:auto;
    }

    .grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;
    }

    /* Cards */
    .card{
      background:linear-gradient(180deg,#fff,#f9fbff);padding:14px;border-radius:10px;
    }

    /* Orders list */
    .orders-list{display:flex;flex-direction:column;gap:10px}
    .order{
      display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfeff);box-shadow:0 4px 10px rgba(12,34,56,0.04);
    }
    .order .left{width:6px;border-radius:6px}
    .order .body{flex:1}
    .order h3{margin:0;font-size:1rem}
    .order p{margin:6px 0;color:var(--muted);font-size:0.9rem}
    .badge{
      padding:6px 8px;border-radius:999px;font-weight:700;font-size:0.78rem;
    }
    .badge.in-progress{background:linear-gradient(90deg,#fff8eb,#fff3d6);color:#b45309}
    .badge.in-review{background:linear-gradient(90deg,#eefbf8,#dff9f3);color:#0f766e}
    .badge.completed{background:linear-gradient(90deg,#f0fdf4,#dff7ea);color:var(--success)}
    .badge.cancelled{background:linear-gradient(90deg,#fff1f2,#ffdfe2);color:var(--danger)}
    .badge.revision{background:linear-gradient(90deg,#f5f3ff,#efedff);color:#6d28d9}

    .order .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .order .meta .small{font-size:0.8rem;color:var(--muted)}

    .order .actions{display:flex;gap:8px}
    .tiny-btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent-2);cursor:pointer;font-weight:600}

    /* Order management table */
    table.orders-table{
      width:100%;border-collapse:collapse;font-size:0.95rem;
    }
    table.orders-table th, table.orders-table td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
    table.orders-table th{font-size:0.85rem;color:var(--muted);font-weight:700}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal-backdrop.show{display:flex}
    .modal{width:100%;max-width:760px;background:white;border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
    .modal h3{margin:0 0 10px 0}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], input[type="email"], select, textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fbfeff;
    }

    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid #e5eef9}
    .btn.primary{background:var(--accent);color:white;box-shadow:0 10px 30px rgba(88,166,255,0.18)}
    .btn.danger{background:var(--danger);color:white}

    /* Footer note */
    .muted{color:var(--muted);font-size:0.88rem}

    /* Responsive */
    @media (max-width:900px){
      .app{grid-template-columns: 1fr; padding:12px}
      .sidebar{display:flex;flex-direction:row;overflow:auto;min-height:unset;padding:10px}
      .nav{flex-direction:row;gap:8px}
      .create-btn{padding:8px}
      .main{margin-top:10px}
    }
  </style>
</head>
<body>

  <div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Primary">
      <div class="brand" style="align-items:center">
        <div class="logo">EC</div>
        <div>
          <h2>Essay Center</h2>
          <p>Order management</p>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="Main Navigation">
        <button class="nav-item active" data-view="dashboard"><i class="fa-solid fa-gauge-high"></i> Dashboard <span class="count" id="count-dashboard">0</span></button>
        <button class="nav-item" data-view="inprogress"><i class="fa-solid fa-spinner"></i> Orders in Progress <span class="count" id="count-inprogress">0</span></button>
        <button class="nav-item" data-view="inreview"><i class="fa-solid fa-user-check"></i> Orders in Review <span class="count" id="count-inreview">0</span></button>
        <button class="nav-item" data-view="completed"><i class="fa-solid fa-check-circle"></i> Orders Completed <span class="count" id="count-completed">0</span></button>
        <button class="nav-item" data-view="cancelled"><i class="fa-solid fa-xmark-circle"></i> Cancelled <span class="count" id="count-cancelled">0</span></button>

        <button class="create-btn" id="openCreate"><i class="fa-solid fa-plus"></i> New Order</button>

        <hr style="border:none;border-top:1px dashed #e6f2ff;margin:10px 0">

        <button class="nav-item" data-view="orders"><i class="fa-solid fa-list"></i> Order Management <span class="count" id="count-all">0</span></button>
      </nav>

      <div style="margin-top:auto;padding-top:12px">
        <p class="muted" style="font-size:0.85rem">Essay Center</p>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" role="main">
      <div class="topbar">
        <div class="wallet" title="Money in orders currently in review">
          <div style="display:flex;flex-direction:column">
            <div class="label">Wallet Balance (In Review)</div>
            <div class="amount" id="walletAmount">KSH 0.00</div>
          </div>
          <div style="margin-left:12px"><i class="fa-solid fa-wallet" style="font-size:20px;color:var(--accent)"></i></div>
        </div>

        <div class="profile" id="profileBtn" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <div class="avatar">A</div>
          <div class="name">Absolom Ondara</div>
          <i class="fa-solid fa-chevron-down" style="color:var(--muted)"></i>

          <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
            <div class="meta">
              <div class="avatar">W</div>
              <div class="info">
                <div class="nm" id="pfName">Absolom Ondara</div>
                <div class="sub" id="pfEmail">absolomjayson46@gmail.com</div>
                <div class="sub" id="pfPhone">+254 724 662 792</div>
              </div>
            </div>
            <hr style="margin:10px 0">
            <div style="display:flex;gap:8px">
              <button class="btn ghost" id="editProfile">Edit</button>
              <button class="btn" id="logoutBtn">Logout</button>
            </div>
          </div>
        </div>
      </div>

      <div class="content" id="contentArea" aria-live="polite">
        <!-- Dashboard view by default -->
        <section id="dashboardView">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h1 style="margin:0">Dashboard</h1>
            <div class="muted">Quick overview of your orders and activity</div>
          </div>

          <div class="grid">
            <div class="card">
              <h3>Total Orders</h3>
              <p id="stat-total" style="font-size:1.6rem;font-weight:800;margin:8px 0 0 0">0</p>
              <p class="muted" style="margin-top:8px">All orders created in the system</p>
            </div>
            <div class="card">
              <h3>In Progress</h3>
              <p id="stat-inprogress" style="font-size:1.6rem;font-weight:800;margin:8px 0 0 0">0</p>
              <p class="muted" style="margin-top:8px">Tasks currently assigned</p>
            </div>
            <div class="card">
              <h3>In Review</h3>
              <p id="stat-inreview" style="font-size:1.6rem;font-weight:800;margin:8px 0 0 0">0</p>
              <p class="muted" style="margin-top:8px">Orders awaiting payment/approval</p>
            </div>
          </div>

          <hr style="margin:18px 0;border:none;border-top:1px solid #f1f5f9">

          <div>
            <h3>Recent Orders</h3>
            <div id="recentList" class="orders-list" style="margin-top:10px"></div>
          </div>
        </section>

        <!-- Simple container placeholders for other views; JS shows/hides -->
        <section id="inprogressView" style="display:none">
          <h2>Orders in Progress</h2>
          <div id="inprogressList" class="orders-list" style="margin-top:10px"></div>
        </section>

        <section id="inreviewView" style="display:none">
          <h2>Orders in Review</h2>
          <div id="inreviewList" class="orders-list" style="margin-top:10px"></div>
        </section>

        <section id="completedView" style="display:none">
          <h2>Completed Orders</h2>
          <div id="completedList" class="orders-list" style="margin-top:10px"></div>
        </section>

        <section id="cancelledView" style="display:none">
          <h2>Cancelled Orders</h2>
          <div id="cancelledList" class="orders-list" style="margin-top:10px"></div>
        </section>

        <section id="ordersView" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h2>Order Management</h2>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="searchOrders" placeholder="Search by title or client" style="padding:8px;border-radius:8px;border:1px solid #eef6ff" />
              <select id="filterStatus" style="padding:8px;border-radius:8px;border:1px solid #eef6ff">
                <option value="">All statuses</option>
                <option value="In Progress">In Progress</option>
                <option value="In Review">In Review</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Revision">Revision</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px;overflow:auto">
            <table class="orders-table" id="ordersTable" aria-describedby="ordersDesc">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Client</th>
                  <th>Assigned</th>
                  <th>Deadline</th>
                  <th>Pages</th>
                  <th>Cost (KSH)</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTBody"></tbody>
            </table>
            <div id="ordersDesc" class="muted" style="margin-top:8px">Use "Change Status" to move orders through your workflow.</div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- CREATE ORDER MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Create New Order</h3>
      <form id="orderForm">
        <div class="form-grid">
          <div>
            <label for="title">Order Title</label>
            <input id="title" name="title" type="text" required placeholder="e.g. Literature review - 1500 words" />
          </div>
          <div>
            <label for="assignedDate">Assigned Date</label>
            <input id="assignedDate" name="assignedDate" type="date" required />
          </div>
          <div>
            <label for="deadline">Deadline</label>
            <input id="deadline" name="deadline" type="date" required />
          </div>
          <div>
            <label for="pages">Amount of Pages</label>
            <input id="pages" name="pages" type="number" min="1" required value="1" />
          </div>
          <div>
            <label for="costPerPage">Cost per Page (KSH)</label>
            <input id="costPerPage" name="costPerPage" type="number" min="0" required value="200" />
          </div>
          <div>
            <label for="client">Client Name</label>
            <input id="client" name="client" type="text" required placeholder="Client name" />
          </div>
          <div style="grid-column:1/-1">
            <label for="notes">Additional Instructions (optional)</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Extra instructions"></textarea>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost" id="cancelCreate">Cancel</button>
          <button type="submit" class="btn primary">Post Order</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /*******************************************************
     * Essay Center — Order Management App (single file)
     *******************************************************/

    // Utility functions
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const formatKsh = v => 'KSH ' + Number(v).toLocaleString('en-KE', {minimumFractionDigits:2, maximumFractionDigits:2});

    // Initial demo user profile (replace with auth values later)
    const profile = {
      name: 'WorldWaysOne',
      email: 'you@example.com',
      phone: '+254 700 000 000'
    };
    $('#pfName').textContent = profile.name;
    $('#pfEmail').textContent = profile.email;
    $('#pfPhone').textContent = profile.phone;
    $('.profile .avatar').textContent = profile.name[0] || 'W';

    // Data management
    const STORAGE_KEY = 'essaycenter_orders_v1';

    function loadOrders(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){console.error(e); return [];}
    }
    function saveOrders(list){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // Create a new order object
    function createOrder(data){
      const id = 'o_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const created = new Date().toISOString();
      const cost = Number(data.pages) * Number(data.costPerPage);
      return {
        id,
        title: data.title,
        assignedDate: data.assignedDate,
        deadline: data.deadline,
        pages: Number(data.pages),
        costPerPage: Number(data.costPerPage),
        cost,
        client: data.client,
        notes: data.notes || '',
        status: 'In Progress',
        created,
        history: [{at:created, by:'system', note:'Order created', status:'In Progress'}]
      };
    }

    // UI Rendering functions
    function setActiveNav(view){
      $$('.nav button.nav-item').forEach(b=>{
        b.classList.toggle('active', b.dataset.view === view);
      });
      // show corresponding view
      const views = ['dashboard','inprogress','inreview','completed','cancelled','orders'];
      views.forEach(v=>{
        const el = $('#' + v + 'View');
        if(el) el.style.display = (v === view) ? '' : 'none';
      });
    }

    function summarizeCounts(orders){
      const total = orders.length;
      const counts = {
        total,
        inprogress: orders.filter(o=>o.status === 'In Progress').length,
        inreview: orders.filter(o=>o.status === 'In Review').length,
        completed: orders.filter(o=>o.status === 'Completed').length,
        cancelled: orders.filter(o=>o.status === 'Cancelled').length
      };
      $('#stat-total').textContent = counts.total;
      $('#stat-inprogress').textContent = counts.inprogress;
      $('#stat-inreview').textContent = counts.inreview;
      $('#count-dashboard').textContent = counts.total;
      $('#count-inprogress').textContent = counts.inprogress;
      $('#count-inreview').textContent = counts.inreview;
      $('#count-completed').textContent = counts.completed;
      $('#count-cancelled').textContent = counts.cancelled;
      $('#count-all').textContent = counts.total;

      // wallet = sum of costs of orders in review
      const wallet = orders.filter(o=>o.status === 'In Review').reduce((s,o)=>s+o.cost,0);
      $('#walletAmount').textContent = formatKsh(wallet);
    }

    function statusBadgeHTML(status){
      const s = status.toLowerCase().replace(' ','-');
      return `<span class="badge ${s}">${status}</span>`;
    }

    function progressForStatus(status){
      switch(status){
        case 'In Progress': return 40;
        case 'In Review': return 70;
        case 'Revision': return 60;
        case 'Completed': return 100;
        case 'Cancelled': return 0;
        default: return 0;
      }
    }

    function renderRecent(orders){
      const container = $('#recentList');
      container.innerHTML = '';
      const recent = orders.slice().sort((a,b)=>new Date(b.created)-new Date(a.created)).slice(0,6);
      if(recent.length===0){
        container.innerHTML = '<div class="muted">No recent orders. Create one with the + button.</div>';
        return;
      }
      recent.forEach(o=>{
        const leftColor = {
          'In Progress':'#ffedd5','In Review':'#ecfeff','Completed':'#ecfdf5','Cancelled':'#fff1f2','Revision':'#f5f3ff'
        }[o.status] || '#e6f2ff';
        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <div class="left" style="background:${leftColor}"></div>
          <div class="body">
            <h3>${escapeHtml(o.title)} <small style="color:var(--muted);font-weight:600">• ${escapeHtml(o.client)}</small></h3>
            <div class="meta">
              ${statusBadgeHTML(o.status)}
              <div class="small">Assigned: ${o.assignedDate}</div>
              <div class="small">Deadline: ${o.deadline}</div>
              <div class="small">Cost: ${formatKsh(o.cost)}</div>
            </div>
            <p class="muted">${o.notes ? escapeHtml(o.notes) : ''}</p>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div class="actions">
              <button class="tiny-btn" onclick="focusOrder('${o.id}')"><i class="fa-solid fa-eye"></i></button>
              <button class="tiny-btn" onclick="quickChangeStatus('${o.id}')"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div style="width:120px">
              <div style="height:8px;background:#eef6ff;border-radius:999px;overflow:hidden">
                <div style="height:8px;width:${progressForStatus(o.status)}%;background:linear-gradient(90deg,var(--accent),#4aa3ff)"></div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderListByStatus(orders, status, containerId){
      const container = $(containerId);
      container.innerHTML = '';
      const list = orders.filter(o=>o.status === status).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
      if(list.length===0){
        container.innerHTML = '<div class="muted">No orders in this section.</div>';
        return;
      }
      list.forEach(o=>{
        const leftColor = {
          'In Progress':'#ffedd5','In Review':'#ecfeff','Completed':'#ecfdf5','Cancelled':'#fff1f2','Revision':'#f5f3ff'
        }[o.status] || '#e6f2ff';
        const d = document.createElement('div');
        d.className = 'order';
        d.innerHTML = `
          <div class="left" style="background:${leftColor}"></div>
          <div class="body">
            <h3>${escapeHtml(o.title)}</h3>
            <div class="meta">
              ${statusBadgeHTML(o.status)}
              <div class="small">Client: ${escapeHtml(o.client)}</div>
              <div class="small">Assigned: ${o.assignedDate}</div>
              <div class="small">Deadline: ${o.deadline}</div>
              <div class="small">Cost: ${formatKsh(o.cost)}</div>
            </div>
            <p class="muted">${o.notes ? escapeHtml(o.notes) : ''}</p>
            <div style="margin-top:8px;display:flex;gap:8px">
              <select data-order="${o.id}" class="changeStatusSelect" aria-label="Change status">
                <option value="In Progress" ${o.status==='In Progress'?'selected':''}>In Progress</option>
                <option value="In Review" ${o.status==='In Review'?'selected':''}>In Review</option>
                <option value="Revision" ${o.status==='Revision'?'selected':''}>Revision</option>
                <option value="Completed" ${o.status==='Completed'?'selected':''}>Completed</option>
                <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
              </select>
              <button class="tiny-btn" onclick="focusOrder('${o.id}')">Details</button>
            </div>
          </div>
        `;
        container.appendChild(d);
      });
    }

    function renderOrdersTable(orders, filter='', search=''){
      const tbody = $('#ordersTBody');
      tbody.innerHTML = '';
      let list = orders.slice().sort((a,b)=>new Date(b.created)-new Date(a.created));
      if(filter) list = list.filter(o=>o.status === filter);
      if(search) list = list.filter(o=> (o.title + ' ' + o.client).toLowerCase().includes(search.toLowerCase()));
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No orders found</td></tr>';
        return;
      }
      list.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(o.title)}</td>
          <td>${escapeHtml(o.client)}</td>
          <td>${o.assignedDate}</td>
          <td>${o.deadline}</td>
          <td>${o.pages}</td>
          <td>${formatKsh(o.cost)}</td>
          <td>${statusBadgeHTML(o.status)}</td>
          <td>
            <select data-order="${o.id}" class="tableChangeStatus" aria-label="Change status">
              <option value="In Progress" ${o.status==='In Progress'?'selected':''}>In Progress</option>
              <option value="In Review" ${o.status==='In Review'?'selected':''}>In Review</option>
              <option value="Revision" ${o.status==='Revision'?'selected':''}>Revision</option>
              <option value="Completed" ${o.status==='Completed'?'selected':''}>Completed</option>
              <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // small helpers
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Quick focus + details (could be expanded into a modal)
    window.focusOrder = function(id){
      const orders = loadOrders();
      const ord = orders.find(o=>o.id===id);
      if(!ord) return alert('Order not found');
      const message = `
Title: ${ord.title}
Client: ${ord.client}
Status: ${ord.status}
Assigned: ${ord.assignedDate}
Deadline: ${ord.deadline}
Pages: ${ord.pages}
Cost: ${formatKsh(ord.cost)}
Notes: ${ord.notes || '-'}
Created: ${new Date(ord.created).toLocaleString()}
      `;
      alert(message);
    };

    // Quick status change helper for recent list (cycles forward)
    window.quickChangeStatus = function(id){
      const orders = loadOrders();
      const ord = orders.find(o=>o.id===id);
      if(!ord) return;
      const orderFlow = ['In Progress','In Review','Revision','Completed'];
      const idx = orderFlow.indexOf(ord.status);
      const next = orderFlow[Math.min(idx+1, orderFlow.length-1)] || 'In Progress';
      changeOrderStatus(id, next, 'user quick change');
    };

    // Change status by id
    function changeOrderStatus(id, newStatus, by='user'){
      const orders = loadOrders();
      const ord = orders.find(o=>o.id===id);
      if(!ord) return;
      ord.status = newStatus;
      ord.history.push({at: new Date().toISOString(), by, note:`Status changed to ${newStatus}`, status:newStatus});
      saveOrders(orders);
      refreshUI();
    }

    // Event listeners & wiring
    function attachEvents(){
      // Nav click
      $$('.nav button.nav-item').forEach(b=>{
        b.addEventListener('click', ()=> {
          const view = b.dataset.view;
          setActiveNav(view);
          // ensure selected view exists
          // nothing else needed; render done by refreshUI
        });
      });

      // Open create modal
      $('#openCreate').addEventListener('click', ()=> openModal());

      $('#cancelCreate').addEventListener('click', ()=> closeModal());

      // modal backdrop close when clicking outside
      $('#modalBackdrop').addEventListener('click', (e)=>{
        if(e.target === $('#modalBackdrop')) closeModal();
      });

      // profile toggle
      $('#profileBtn').addEventListener('click', (e)=>{
        $('#profileMenu').classList.toggle('show');
      });

      // logout simulated
      $('#logoutBtn').addEventListener('click', ()=> { alert('Logged out (demo)'); });

      // create form submit
      $('#orderForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const form = e.target;
        const data = {
          title: form.title.value.trim(),
          assignedDate: form.assignedDate.value,
          deadline: form.deadline.value,
          pages: form.pages.value,
          costPerPage: form.costPerPage.value,
          client: form.client.value.trim(),
          notes: form.notes.value.trim()
        };
        // basic validation
        if(!data.title || !data.assignedDate || !data.deadline || !data.pages || !data.costPerPage || !data.client){
          return alert('Please fill required fields.');
        }
        const ord = createOrder(data);
        const orders = loadOrders();
        orders.push(ord);
        saveOrders(orders);
        closeModal();
        setActiveNav('inprogress'); // go to inprogress after creating
        refreshUI();
      });

      // Search/filter in orders table
      $('#searchOrders').addEventListener('input', (e)=>{
        renderOrdersTable(loadOrders(), $('#filterStatus').value, e.target.value.trim());
      });
      $('#filterStatus').addEventListener('change', ()=> {
        renderOrdersTable(loadOrders(), $('#filterStatus').value, $('#searchOrders').value.trim());
      });

      // Delegated event listeners for selects in lists & table
      document.addEventListener('change', (e)=>{
        if(e.target.matches('.changeStatusSelect, .tableChangeStatus')){
          const id = e.target.dataset.order;
          const newStatus = e.target.value;
          changeOrderStatus(id, newStatus, 'user change');
        }
      });
    }

    // Modal controls
    function openModal(){
      $('#modalBackdrop').classList.add('show');
      $('#modalBackdrop').setAttribute('aria-hidden','false');
      // set default assigned date to today
      const today = new Date().toISOString().slice(0,10);
      $('#assignedDate').value = today;
      // set default deadline 3 days ahead
      const then = new Date(); then.setDate(then.getDate()+3);
      $('#deadline').value = then.toISOString().slice(0,10);
    }
    function closeModal(){
      $('#modalBackdrop').classList.remove('show');
      $('#modalBackdrop').setAttribute('aria-hidden','true');
      $('#orderForm').reset();
    }

    // Seed some demo orders if none exist (for fast testing)
    function seedDemoIfEmpty(){
      const orders = loadOrders();
      if(orders.length === 0){
        const sample = [
          {title:'Literature Review on AI Ethics', assignedDate: todayAdd(-2), deadline: todayAdd(3), pages:5, costPerPage:250, client:'Adamu', notes:'Include 5 refs', status:'In Progress'},
          {title:'Methodology Chapter', assignedDate: todayAdd(-4), deadline: todayAdd(1), pages:6, costPerPage:220, client:'Beatrice', notes:'APA 7', status:'In Review'},
          {title:'Final Edits and Proofread', assignedDate: todayAdd(-8), deadline: todayAdd(-1), pages:3, costPerPage:200, client:'Chalo', notes:'Urgent', status:'Completed'}
        ].map(s=>{
          const o = createOrder(s);
          o.pages = s.pages; o.costPerPage = s.costPerPage; o.cost = s.pages * s.costPerPage; o.status = s.status;
          o.history.push({at:new Date().toISOString(), by:'seed', note:'Seeded order', status:o.status});
          return o;
        });
        saveOrders(sample);
      }
    }
    function todayAdd(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

    // Full refresh
    function refreshUI(){
      const orders = loadOrders();
      summarizeCounts(orders);
      renderRecent(orders);
      renderListByStatus(orders, 'In Progress', '#inprogressList');
      renderListByStatus(orders, 'In Review', '#inreviewList');
      renderListByStatus(orders, 'Completed', '#completedList');
      renderListByStatus(orders, 'Cancelled', '#cancelledList');
      renderOrdersTable(orders, $('#filterStatus').value, $('#searchOrders').value.trim());
    }

    // Initialization
    (function init(){
      attachEvents();
      seedDemoIfEmpty();
      refreshUI();
      setActiveNav('dashboard');
      // keyboard escape to close modal
      document.addEventListener('keydown', (e)=> {
        if(e.key === 'Escape') { closeModal(); $('#profileMenu').classList.remove('show'); }
      });
    })();

  </script>
</body>
</html>
